<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TopShop Deals</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <!-- background -->
  <canvas id="snow" aria-hidden="true"></canvas>

  <!-- YouTube audio (only loads after Enter click) -->
  <iframe
    id="yt"
    class="yt"
    title="music"
    allow="autoplay; encrypted-media"
    referrerpolicy="strict-origin-when-cross-origin"
  ></iframe>

  <!-- Enter overlay -->
  <div class="overlay" id="overlay" tabindex="0" role="button" aria-label="Click to enter">
    <div class="enter-wrap">
      <div class="enter-ring" aria-hidden="true"></div>
      <div class="enter-grid" aria-hidden="true"></div>

      <img class="enter-logo" id="enterLogo" alt="TopShop Deals logo" />

      <div class="enter-name">TopShop Deals</div>
      <div class="enter-tag">Akcijos • Deal’ai • Naujienos</div>

      <button class="enter-btn" type="button" id="enterBtn">
        Click to enter
      </button>

      <div class="enter-hint">Enter / Space taip pat veikia</div>
    </div>
  </div>

  <!-- main -->
  <main class="center" id="main" data-hidden="true">
    <section class="card">
      <div class="brand">
        <img class="avatar" id="avatar" alt="TopShop Deals logo" />
        <div class="brandtext">
          <div class="brandtitle">TopShop Deals</div>
          <div class="brandsub">Geriausi pasiūlymai vienoje vietoje</div>
        </div>
      </div>

      <h1 class="title">
        <span class="warn" aria-hidden="true">⚠️</span>
        SVETAINĖ KURIAMA
      </h1>

      <p class="desc">
        Šiuo metu svetainė yra kuriama.<br>
        Norint užsisakyti – susisiekite su mumis Discord serveryje.
      </p>

      <!-- stats -->
      <div class="statsrow">
        <div class="chip">
          <div class="chip-label">Dabar online</div>
          <div class="chip-value" id="onlineCount">—</div>
        </div>
        <div class="chip">
          <div class="chip-label">Viso peržiūrų</div>
          <div class="chip-value" id="totalViews">—</div>
        </div>
      </div>

      <!-- actions -->
      <div class="btnrow">
        <a class="btn" href="https://discord.gg/hup2TpqkUT" target="_blank" rel="noopener">
          Susisiekti
        </a>
      </div>

      <div class="foot">
        <span class="dot"></span>
        <span>Live • TopShop Deals</span>
      </div>
    </section>
  </main>

  <script>
    // ---------- Avatar / Logo ----------
    const DEFAULT_AVATAR =
      "https://cdn.discordapp.com/attachments/1445929063872204800/1459177866968436749/ChatGPT_Image_Jan_9_2026_03_31_44_PM.png?ex=69702c89&is=696edb09&hm=c4a8c6c4816de81f6710670cac34157517d77a0911587a5190e08acffff56cff&";

    const params = new URLSearchParams(location.search);
    const imgUrl = params.get("img") || DEFAULT_AVATAR;

    const avatar = document.getElementById("avatar");
    const enterLogo = document.getElementById("enterLogo");

    for (const el of [avatar, enterLogo]) {
      el.referrerPolicy = "no-referrer";
      el.src = imgUrl;
      el.addEventListener("error", () => { el.src = DEFAULT_AVATAR; });
    }

    // ---------- Music ----------
    const yt = document.getElementById("yt");
    const YT_ID = "r9xWOA_S3_g"; // from your link
    function startMusic(){
      yt.src =
        "https://www.youtube-nocookie.com/embed/" + YT_ID +
        "?autoplay=1&mute=0&controls=0&loop=1&playlist=" + YT_ID +
        "&playsinline=1&rel=0";
    }

    // ---------- Stats ----------
    async function refreshStats(){
      try{
        await fetch("/ping", { method: "POST" });
        const r = await fetch("/stats");
        const data = await r.json();
        document.getElementById("onlineCount").textContent = data.online;
        document.getElementById("totalViews").textContent = data.total_views;
      }catch(e){
        // ignore
      }
    }

    // ---------- Enter ----------
    const overlay = document.getElementById("overlay");
    const enterBtn = document.getElementById("enterBtn");
    const main = document.getElementById("main");

    function enter(){
      overlay.classList.add("hide");
      main.dataset.hidden = "false";
      startSnow();
      startMusic();

      refreshStats();
      setInterval(refreshStats, 10000);
    }

    overlay.addEventListener("click", enter);
    enterBtn.addEventListener("click", (e) => { e.stopPropagation(); enter(); });

    overlay.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") enter();
    });

    // ---------- Snow (canvas) ----------
    const canvas = document.getElementById("snow");
    const ctx = canvas.getContext("2d");
    let W = 0, H = 0, flakes = [];
    let running = false;

    function resize() {
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      W = window.innerWidth;
      H = window.innerHeight;

      const count = Math.floor((W * H) / 10500);
      flakes = Array.from({ length: count }, () => makeFlake(true));
    }

    function makeFlake(initial=false) {
      const size = 0.9 + Math.random() * 2.8;
      return {
        x: Math.random() * W,
        y: initial ? Math.random() * H : -10 - Math.random() * 150,
        r: size,
        vy: 0.75 + Math.random() * 2.0,
        vx: -0.35 + Math.random() * 0.7,
        a: 0.20 + Math.random() * 0.65,
        wob: Math.random() * Math.PI * 2,
        wobSpd: 0.004 + Math.random() * 0.012
      };
    }

    function drawBackground() {
      const g = ctx.createLinearGradient(0, 0, W, H);
      g.addColorStop(0.00, "#071c3e");
      g.addColorStop(0.35, "#061632");
      g.addColorStop(0.70, "#040a18");
      g.addColorStop(1.00, "#02040c");
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, W, H);

      const r = ctx.createRadialGradient(W*0.18, H*0.25, 0, W*0.18, H*0.25, Math.max(W,H)*0.6);
      r.addColorStop(0, "rgba(80,140,255,0.22)");
      r.addColorStop(1, "rgba(80,140,255,0)");
      ctx.fillStyle = r;
      ctx.fillRect(0, 0, W, H);

      const r2 = ctx.createRadialGradient(W*0.80, H*0.75, 0, W*0.80, H*0.75, Math.max(W,H)*0.7);
      r2.addColorStop(0, "rgba(120,90,255,0.10)");
      r2.addColorStop(1, "rgba(120,90,255,0)");
      ctx.fillStyle = r2;
      ctx.fillRect(0, 0, W, H);
    }

    function step(t) {
      if (!running) return;

      drawBackground();

      for (let i = 0; i < flakes.length; i++) {
        const f = flakes[i];
        f.wob += f.wobSpd * (t || 0);
        const drift = Math.sin(f.wob) * 0.45;

        f.x += (f.vx + drift);
        f.y += f.vy;

        if (f.y > H + 25) flakes[i] = makeFlake(false);
        if (f.x < -35) f.x = W + 35;
        if (f.x > W + 35) f.x = -35;

        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${f.a})`;
        ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
        ctx.fill();
      }

      requestAnimationFrame(step);
    }

    function startSnow() {
      if (running) return;
      running = true;
      resize();
      requestAnimationFrame(step);
    }

    window.addEventListener("resize", () => {
      if (!running) return;
      resize();
    });

    // show background even before enter
    resize();
    drawBackground();
  </script>
</body>
</html>
